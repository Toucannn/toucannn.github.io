<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="/TartuSuurvesi/style.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<body style="margin: 0;">
  <div id="loading" class="loading hidden" role="status" aria-live="polite">
    Kihtide laadimine…
  </div>

  <div id="map" style="height: 100vh;"></div>
  <script>
    const map = L.map('map').setView([58.368, 26.729], 12);
    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    })
    const maaamet = L.tileLayer('https://tiles.maaamet.ee/tm/tms/1.0.0/foto@GMC/{z}/{x}/{y}.png', {
      tms: true,
      maxZoom: 20,
      attribution: '© Maaamet'
    }).addTo(map);
  
    
    // Layers control containers
    const baseLayers = {
      'Maa- ja ruumiamet': maaamet,
      'OpenStreetMap': osm,
    };

    const hybrid_map = L.tileLayer('https://tiles.maaamet.ee/tm/tms/1.0.0/hybriid@GMC/{z}/{x}/{y}.png', {
      tms: true,
      maxZoom: 20,
      attribution: '© Maaamet'
    }).addTo(map);

    let overlays = {
      'Hübriidkaart': hybrid_map
    };
    // const layersControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map); // Leaflet layers control [3](https://leafletjs.com/examples/layers-control/)
  
  
    // --- Configure your repo ---
    const owner = 'toucannn';
    const repo = 'toucannn.github.io';
    const branch = 'main';       // or 'gh-pages'
    const path = 'assets/layers';       // the folder with .geojson files
  
    // Optional: add an auth token to raise rate limits
    const headers = {
      'Accept': 'application/vnd.github+json'
      // ,'Authorization': 'Bearer YOUR_TOKEN'  // uncomment if needed
    };
  
    async function loadAllLayers() {
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
      const listing = await (await fetch(url, { headers })).json();
  
      // Filter to .geojson files
      const files = listing.filter(entry =>
        entry.type === 'file' && entry.name.toLowerCase().endsWith('.geojson')
      );
  
      for (const file of files) {
        // Preferred: use the download_url (a raw URL with proper CORS for JSON)
        console.log("downloading from url:", file);
        const layerName = file.name.replace('.geojson', '');
        console.log("layerName", layerName)
        const geojson = await (await fetch(file.download_url)).json();
        const layer = L.geoJSON(geojson)
        overlays[layerName] = layer;
        // layer.addTo(map);
      }
    }
  
    // loadAllLayers().catch(console.error).then(() => {
    //   console.log("overlays", overlays)
    //   const layersControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map); // Leaflet layers control [3](https://leafletjs.com/examples/layers-control/)
    // })

    const loadingEl = document.getElementById("loading");

    function setLoading(isLoading, text = "Kihtide laadimine…") {
      loadingEl.textContent = text;
      loadingEl.classList.toggle("hidden", !isLoading);
    }

    async function run() {
      setLoading(true);
      try {
        await loadAllLayers().catch(console.error).then(() => {
          console.log("overlays", overlays)
          const layersControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);
        })
      } catch (err) {
        console.error(err);
        setLoading(true, "Kihtide laadimine ebaõnnestus (vaata konsooli).");
        setTimeout(() => setLoading(false), 2000);
        return
      } finally {
        setLoading(false);
      }
    }

    run();
  
  </script>
</body>